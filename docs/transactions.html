<!-- HTML header for doxygen 1.8.3.1-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta name="generator" content="Doxygen 1.8.11"/>
<title>OpenAssetIO [beta]: Transactions</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { init_search(); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="styles.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="all-content">
<div id="body-content">
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">OpenAssetIO [beta]
   </div>
   <div id="projectbrief">An abstract API for generalising interactions between a host application and an asset management system</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.11 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('transactions.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Transactions </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="transactions_background"></a>
Background</h1>
<p>When a host needs to register multiple assets as part of a compound structure or logical group, the <a class="el" href="glossary.html#ManagerInterface">ManagerInterface</a> includes methods to bookend a series of API calls as a single transaction.</p>
<p>Transactions behave similarly to those in a database, in that any changes made within any given transaction should be considered atomic, and not exposed to the public state until the transaction has been completed. Canceling a transaction mid way should discard the effects of any previous actions it included.</p>
<dl class="section see"><dt>See also</dt><dd><a class="el" href="classopenassetio_1_1manager_a_p_i_1_1_manager_interface_1_1_manager_interface.html#a2733c10fdc6a3a2763db937698fc7704">ManagerInterface.startTransaction</a> </dd>
<dd>
<a class="el" href="classopenassetio_1_1manager_a_p_i_1_1_manager_interface_1_1_manager_interface.html#a4ac10446eaffc0d310682e2c9a3d5b8a">ManagerInterface.finishTransaction</a> </dd>
<dd>
<a class="el" href="classopenassetio_1_1manager_a_p_i_1_1_manager_interface_1_1_manager_interface.html#a178c25c66ff28b1b9f5d3900bbb0fe31">ManagerInterface.cancelTransaction</a></dd></dl>
<p>For more details on the requirements of the <a class="el" href="glossary.html#asset_management_system">Asset Management System</a> in relation to transaction handling, see the <a class="el" href="transactions.html#transactions_for_the_manager">Transaction Support in a Manager</a> section below.</p>
<h1><a class="anchor" id="transactions_example"></a>
Example Host Code</h1>
<p>Lets take the case of publishing a shot and it's clips from an editorial application. Simplified pseudo-code within a host for the transaction handling may look something like this:</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">def </span>create_shot_with_clips(self, shot, entity_ref, context):</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;   <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="stringliteral">   Creates a shot, and publishes all its clips under it.</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="stringliteral">   &quot;&quot;&quot;</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;   manager.startTransaction(context)</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;   <span class="keywordflow">try</span>:</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;       <span class="comment"># Create the shot first, so we can then publish the clips to it</span></div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;       shot_ref = manager.register([entity_ref], [shot.traitsData()], context)[0]</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;       <span class="comment"># Register the clips to the shot&#39;s entity reference</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;       register_clips(shot.clips, shot_ref, context)</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;   <span class="keywordflow">except</span> Exception <span class="keyword">as</span> e:</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;       manager.cancelTransaction(context)</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;       <span class="keywordflow">raise</span> e</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;   manager.finishTransaction(context)</div></div><!-- fragment --><p>This all seems very straight forward. Until we consider the case of a naive multi-shot export :</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">def </span>create_all_shots_with_clips(sequence, entity_reference, context):</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;   <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="stringliteral">   Creates all the shots in a sequence, along with their clips.</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="stringliteral">   &quot;&quot;&quot;</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;   <span class="keywordflow">for</span> shot <span class="keywordflow">in</span> sequence.shots:</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;     create_shot_with_clips(shot, entity_reference, context)</div></div><!-- fragment --><p>This would end up creating a new transaction for each individual shot instead of one transaction for the whole sequence. We need a simpler way for hosts to manage transactions in structured code.</p>
<h1><a class="anchor" id="transactions_action_groups"></a>
Action Groups</h1>
<p>The <a class="el" href="classopenassetio_1_1host_a_p_i_1_1transactions_1_1_transaction_coordinator.html">TransactionCoordinator</a> simplifies the process of managing transactions within a host's code base. It introduces the concept of an Action Group. These groups are pushed onto a stack. The coordinator takes care of starting, finishing or cancelling a transaction with the manager whenever there is more than one action on the stack.</p>
<p>The contrived sequence publishing example code has been updated below to use this mechanism, with the result that only a single transaction would be create for both the singular and sequence use cases.</p>
<div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="keyword">def </span>create_shot_with_clips(shot, entityRef, context, coordinator):</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;   <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;<span class="stringliteral">   Creates a shot, and publishes all its clips under it.</span></div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;<span class="stringliteral">   &quot;&quot;&quot;</span></div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;   with coordinator.scopedActionGroup(context):</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;       <span class="comment"># Create the shot so we can publish</span></div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;       shot_ref = manager.register([entity_ref], [shot.traitsData()], context)[0]</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;       <span class="comment"># Register the clips to the shots entity reference</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;       register_clips(shot.clips, shot_ref, context)</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;<span class="keyword">def </span>create_all_shots(sequence, entity_reference, context, coordinator):</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;   <span class="stringliteral">&quot;&quot;&quot;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="stringliteral">   Creates all the shots in a sequence, along with their clips.</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="stringliteral">   &quot;&quot;&quot;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;   with coordinator.scopedActionGroup(context):</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;       <span class="keywordflow">for</span> shot <span class="keywordflow">in</span> sequence.shots:</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;           create_shot_with_clips(shot, entity_reference, context, coordinator)</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;coordinator = openassetio.hostAPI.TransactionCoordinator(manager)</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;create_all_shots(sequence, entity_reference, context, coordinator)</div></div><!-- fragment --><p>The TransactionCoordinator also takes care of (optionally) cancelling a transaction in the case of an exception being raised within the block</p>
<p>The result is that well-behaved, transaction aware host API code should be easier to write using the TransactionCoordinator in place of the low-level transaction methods of the Manager.</p>
<dl class="section warning"><dt>Warning</dt><dd>It is critical that a host uses the same context (or a child of it) for any given transaction, as the transaction is anchored to the context, not the API session.</dd></dl>
<p>From the manager's perspective, it only sees a single set of coalesced calls to either start, finish or cancel as appropriate.</p>
<h1><a class="anchor" id="transactions_for_the_manager"></a>
Transaction Support in a Manager</h1>
<p>Due to the additional back-end complexity, transaction support in the implementation of any given <a class="el" href="glossary.html#asset_management_system">Asset Management System</a> is entirely optional. There is no hard requirement to support this API and the default implementation makes it simply a no-op.</p>
<p>If a manager natively supports the concept of transactions, mapping them to the OpenAssetIO model can make state management around error cases more straightforward in supporting hosts.</p>
<p>The <a class="el" href="stable_resolution.html#stable_resolution_manager_state">Manager State</a> mechanism allows between API calls to be correlated. This is used as the basis of the transaction system.</p>
<p>Whenever a <a class="el" href="glossary.html#Context">Context</a> is created, The <a class="el" href="glossary.html#ManagerInterface">ManagerInterface</a> class has the opportunity to insert a persistent state object. This object is persisted for as long as the context is kept alive.</p>
<p>The first time a host calls <a class="el" href="classopenassetio_1_1host_a_p_i_1_1transactions_1_1_transaction_coordinator.html#af4355c5cc77bf8c91ecc532386de1b73">pushActionGroup</a> then the TransactionCoordinator will start a new transaction via <a class="el" href="classopenassetio_1_1manager_a_p_i_1_1_manager_interface_1_1_manager_interface.html#a2733c10fdc6a3a2763db937698fc7704">startTransaction</a>. This call is passed the state token from the host's Context, this can be used as an anchor for the transaction as subsequent API calls made as part of that transaction will have the same state token in their context.</p>
<p>The host is then free to push/pop groups as it wishes. Once the last open group has been popped, the TransactionCoordinator will call <a class="el" href="classopenassetio_1_1manager_a_p_i_1_1_manager_interface_1_1_manager_interface.html#a4ac10446eaffc0d310682e2c9a3d5b8a">finishTransaction</a>.</p>
<p>Should an fatal error arise in the host, then it will call openassetio.transactions.TransactionCoordinator.cancelActions with the Context, which in turn, will call <a class="el" href="classopenassetio_1_1manager_a_p_i_1_1_manager_interface_1_1_manager_interface.html#a178c25c66ff28b1b9f5d3900bbb0fe31">cancelTransaction</a> to instruct the manager to attempt to undo/rollback any changes made during the transaction.</p>
<h2><a class="anchor" id="transactions_for_the_manager_registration"></a>
Registration</h2>
<p>In our shot creation example above, it can be noted that the registration of the shot, must be completed before its clips can be registered. This is because clip registration needs the shot's <a class="el" href="glossary.html#entity_reference">Entity Reference</a> to register to.</p>
<dl class="section warning"><dt>Warning</dt><dd>Consequently, calls to <a class="el" href="classopenassetio_1_1manager_a_p_i_1_1_manager_interface_1_1_manager_interface.html#ae26852e96b33172789f7b3f5d7fd97ad">preflight</a> or <a class="el" href="classopenassetio_1_1manager_a_p_i_1_1_manager_interface_1_1_manager_interface.html#abbd3bb320b56068b8e23e1aefd26767e">register</a> performed as part of a transaction must produce valid references that can be used within the same transaction for subsequent registrations. </dd></dl>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- HTML footer for doxygen 1.8.3.1-->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
  </ul>
</div>
<hr class="footer"/>
<p id="copyright"><small>Copyright 2013-2021 The Foundry Visionmongers Ltd. OpenAssetIO is released under the <a href="https://www.apache.org/licenses/LICENSE-2.0.txt" target="_blank">Apache 2.0 License</a></small></p>
</div>
</body>
</html>
